<html lang="en">
    <head>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.2/css/bulma.min.css">
        <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
    </head>

    <body>
        <div id="root">
            <div class="section">
                <div class="box">
                    <div class="container">
                        <button class="button" type="button" 
                            v-for="btn in Object.keys(animateBtns)" v-on:click="animate(btn)">
                            {{ btn }}
                        </button>
                    </div>
                    <div class="container is-flex" style="flex-wrap:wrap">
                        <div v-for="screen of screens" style="margin:3px">
                            <div>{{ screen.displayName === undefined ? screen.name : screen.displayName }}</div>
                            <canvas :id="screen.name+' map'" :width="screen.canvasWidth||160" :height="screen.canvasHeight||144"></canvas>
                            <canvas v-if="screen.showTileData === true" canvas :id="screen.name+' data'" width="256" height="96"></canvas>
                            <canvas v-if="screen.showTileData === true" canvas :id="screen.name+' data2'" width="256" height="96"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let bankConv = function(bank, addr) {
                if (bank === 0) return addr;
                return (bank - 1) * 0x4000 + addr;
            }

            let printBytes = function(bytes) {
                console.log(bytes.map(i => i.toString(16)).join(' '));
            }

            let wordIn = function(rom, addr) {
                return (rom[addr+1]<<8)+rom[addr];
            }

            class Screen {
                constructor(screenSpec, rom) {
                    this.memory = new Array(0x10000).fill(0);
                    this.vram1 = new Array(0x2000).fill(0);
                    this.bgPalettes = new Array(0x40).fill(0);
                    this.rom = null;
                    this.screenSpec = screenSpec;
                    this.rom = rom;
                    this.is8000 = screenSpec.is8000;
                    this.animateIdx = screenSpec.animateStartIdx;
                    this.canAnimate = false;
                }

                drawScreen() {
                    let screen = this.screenSpec;
                    let name = screen.name;
                    let tiledata_canvas = `${name} data`;
                    let tiledata2_canvas = `${name} data2`;
                    let tilemap_canvas = `${name} map`;

                    // Gen animated sources
                    if (this.screenSpec.animated && this.canAnimate) {
                        let animation = this.screenSpec.animateFunc(this.animateIdx++, this.rom);
                        screen.sources = animation.sources;

                        if (this.animateIdx > this.screenSpec.animateEndIdx) 
                            this.animateIdx = this.screenSpec.animateStartIdx;
                        screen.name = animation.name;
                    }

                    // set vram sources
                    for (let i = 0; i < screen.sources.length; i++) {
                        let [algo, bank, addr, dest, ...args] = screen.sources[i];
                        this[algo](bankConv(bank, addr), dest, ...args);
                    }

                    this.drawBytes(this.memory.slice(0x8000, 0x9800), null, tiledata_canvas, 32, 32, 12, false);
                    this.drawBytes(this.vram1.slice(0x0000, 0x1800), null, tiledata2_canvas, 32, 32, 12, false);
                    let layoutBytes0 = this.populateLayout(0);
                    let layoutBytes1 = this.populateLayout(1);
                    this.drawBytes(
                        layoutBytes0, layoutBytes1,
                        tilemap_canvas, 32, 
                        this.screenSpec.colsShown || 20, 
                        this.screenSpec.rowsShown || 18, 
                        screen.isGBC);

                    if (this.screenSpec.animated && this.canAnimate) {
                        setTimeout(this.drawScreen.bind(this), 1000./60. * (this.screenSpec.animateDelay||3));
                    }
                }

                simpleCopy(addr, dest, numBytes, srcLoc, destLoc) {
                    srcLoc = srcLoc || 'rom';
                    destLoc = destLoc || 'memory';
                    for (let i = 0; i < numBytes; i++)
                        this[destLoc][dest+i] = this[srcLoc][addr+i];
                }

                screenCopy(addr, dest, srcLoc, destLoc, width, height) {
                    srcLoc = srcLoc || 'rom';
                    destLoc = destLoc || 'memory';
                    width = width || 0x14;
                    height = height || 0x12;
                    for (let row = 0; row < height; row++) {
                        for (let col = 0; col < width; col++) {
                            this[destLoc][dest+row*0x20+col] = this[srcLoc][addr+row*width+col];
                        }
                    }
                }

                setBytes(addr, dest, ...bytes) {
                    for (let i = 0; i < bytes.length; i++)
                        this.memory[dest+i] = bytes[i];
                }

                fillScreen(fillVal) {
                    fillVal = fillVal || 0xff;
                    for (let i = 0x9800; i < 0x9c00; i++)
                        this.memory[i] = fillVal;
                }

                getTileData(idx, bank, force8800) {
                    if (this.is8000 && !force8800) {
                        let base = 0x8000 + idx*16;
                        if (bank === 0)
                            return this.memory.slice(base, base+16);
                        return this.vram1.slice(idx*16, idx*16+16);
                    }

                    let base;
                    if (idx >= 0x80) {
                        base = 0x8800 + (idx-0x80) * 16;
                    } else {
                        base = 0x9000 + idx * 16;
                    }
                    if (bank === 0)
                        return this.memory.slice(base, base+16);
                    return this.vram1.slice(base-0x8000, base+16-0x8000);
                }

                rleXorCopy(addr, dest) {
                    let lastByte = 0;
                    let numCopies = wordIn(this.rom, addr);
                    let offset = 2;
                    let destOffset = 0;
                    for (let i = 0; i < numCopies; i++) {
                        let specByte = this.rom[addr+offset++];

                        if (specByte & 0x80) {
                            let count = specByte - 0x7e;
                            let copyByte = this.rom[addr+offset++];
                            for (let j = 0; j < count; j++) {
                                lastByte ^= copyByte;
                                this.memory[dest+destOffset++] = lastByte;
                            }
                        } else {
                            let count = specByte+1;
                            let lastCopied = lastByte;
                            for (let j = 0; j < count; j++) {
                                lastByte ^= this.rom[addr+offset++];
                                this.memory[dest+destOffset++] = lastByte;
                            }
                        }
                    }
                    console.log(
                        this.screenSpec.name, 
                        (addr+offset).toString(16), 
                        (dest+destOffset).toString(16));
                }

                drawKanjis(addr, dest) {
                    let destOffset = 0; // 1 for 2nd kanji, etc
                    let kanjiOffset = 0;
                    while (true) {
                        let kanji = this.rom[addr+kanjiOffset++];
                        let quarterBankOffset = 0;
                        if (kanji === 0) break;

                        if (kanji < 8) {
                            quarterBankOffset = kanji;
                            kanji = this.rom[addr+kanjiOffset++];
                        } else if (kanji === 0x0d) {
                            break;
                        } else if (kanji === 0x08) {
                            kanjiOffset++;
                        } else if (kanji < 0x10) {
                            console.log(kanji)
                        }
                        let src = bankConv(6, 0x4000+quarterBankOffset*0x1000)+kanji*0x10;
                        for (let i = 0; i < 0x10; i++) {
                            this.memory[dest+destOffset*0x20+i*2] = this.rom[src+i];
                            this.memory[dest+destOffset*0x20+i*2+1] = this.rom[src+i];
                        }
                        destOffset++;
                    }
                    for (let i = 0; i < destOffset; i++) {
                        this.memory[0x9800+(dest-0x8800)/8+i] = (dest-0x8000)/0x10+i*2;
                        this.memory[0x9820+(dest-0x8800)/8+i] = (dest-0x8000)/0x10+i*2+1;
                    }
                }

                spriteCopy(addr, dest, is16height, xOffset, yOffset) {
                    let timeout_ctr = 40;
                    let startOffset = 0;
                    xOffset = xOffset || 0;
                    yOffset = yOffset || 0;
                    while (true) {
                        let y = this.rom[addr+startOffset++];
                        let x = this.rom[addr+startOffset++];
                        let tile = this.rom[addr+startOffset++];
                        let attr = this.rom[addr+startOffset++];

                        y += yOffset; if (y > 0x100) y -= 0x100;
                        x += xOffset; if (x > 0x100) x -= 0x100;

                        let tileY = Math.floor(y/8);
                        let tileX = Math.floor(x/8);
                        this.memory[dest+tileY*0x20+tileX] = tile;
                        this.vram1[dest+tileY*0x20+tileX-0x8000] = attr;

                        if (is16height) {
                            this.memory[dest+tileY*0x20+tileX+0x20] = tile+1;
                            this.vram1[dest+tileY*0x20+tileX-0x8000+0x20] = attr;
                        }

                        if ((attr & 0x10) !== 0) break;

                        if (--timeout_ctr === 0) break;
                    }
                }

                sceneryCopy(sceneryIdx) {
                    let sceneryAddr = bankConv(0x0a, 0x4af0+sceneryIdx*12);
                    let addr1 = bankConv(this.rom[sceneryAddr+2], this.rom[sceneryAddr+1]*0x100+this.rom[sceneryAddr+0]);
                    let addr2 = bankConv(this.rom[sceneryAddr+5], this.rom[sceneryAddr+4]*0x100+this.rom[sceneryAddr+3]);
                    let addr3 = bankConv(this.rom[sceneryAddr+8], this.rom[sceneryAddr+7]*0x100+this.rom[sceneryAddr+6]);
                    let addr4 = bankConv(this.rom[sceneryAddr+11], this.rom[sceneryAddr+10]*0x100+this.rom[sceneryAddr+9]);
                    this.rleXorCopy(addr1, 0xd000);
                    this.simpleCopy(0xd000, 0x9000, 0x1000, 'memory', 'memory');
                    this.rleXorCopy(addr2, 0xd000);
                    this.simpleCopy(0xd000, 0x1000, 0x1000, 'memory', 'vram1');
                    this.screenCopy(addr3, 0x9800, 'rom', 'memory', 0x14, 0x0a);
                    this.screenCopy(addr3+0xc8, 0x1800, 'rom', 'vram1', 0x14, 0x0a);
                    this.simpleCopy(addr4, 0x0000, 0x40, 'rom', 'bgPalettes');
                }

                populateLayout(bank) {
                    return this.memory.slice(0x9800, 0x9c00).reduce(
                        (prev, curr) => [...prev, ...this.getTileData(curr, bank)],
                        []
                    );
                }

                pal20hbytes(srcLoc) {
                    let colBgPalettes = [];
                    for (let paletteIdx = 0; paletteIdx < 4; paletteIdx++) {
                        let palCols = [];
                        for (let colIdx = 0; colIdx < 4; colIdx++) {
                            let bgPalIdx = paletteIdx * 8 + colIdx * 2;
                            let b1 = srcLoc[bgPalIdx];
                            let b2 = srcLoc[bgPalIdx+1];
                            let r = b1 & 0x1f;
                            let g = (b1 >> 5)+((b2 & 3)<<3);
                            let b = (b2 >> 2);
                            palCols.push([r*8, g*8, b*8]);
                        }
                        colBgPalettes.push(palCols);
                    }
                    return colBgPalettes;
                }

                pal40hbytes(srcLoc) {
                    let colBgPalettes = [];
                    for (let paletteIdx = 0; paletteIdx < 8; paletteIdx++) {
                        let palCols = [];
                        for (let colIdx = 0; colIdx < 4; colIdx++) {
                            let bgPalIdx = paletteIdx * 8 + colIdx * 2;
                            let b1 = srcLoc[bgPalIdx];
                            let b2 = srcLoc[bgPalIdx+1];
                            let r = b1 & 0x1f;
                            let g = (b1 >> 5)+((b2 & 3)<<3);
                            let b = (b2 >> 2);
                            palCols.push([r*8, g*8, b*8]);
                        }
                        colBgPalettes.push(palCols);
                    }
                    return colBgPalettes;
                }

                drawBytes(bytes, bytes2, canvas_id, numTilesPerRow, numTilesShownPerCol, numTilesShownPerRow, isGBC) {
                    let canvas = document.getElementById(canvas_id);
                    if (!canvas) return;
                    let ctx = canvas.getContext("2d");

                    let width = canvas.width, height = canvas.height;
                    let myImageData = ctx.createImageData(width, height);
                    let data = myImageData.data;

                    let bgPalettes = [0xff, 0xaa, 0x55, 0x00];
                    let colBgPalettes = [];
                    if (isGBC) {
                        colBgPalettes = this.pal40hbytes(this.bgPalettes);
                    }

                    let numTiles = bytes.length / 16;
                    let numTilesPerCanvasRow = width / 8;
                    for (let i = 0; i < numTiles; i++) {
                        let tileAttr = this.vram1[0x1800+i];
                        let tileBytes;

                        if ((tileAttr & 8) && bytes2 !== null) {
                            tileBytes = bytes2.slice(i * 16, (i+1) * 16);
                        } else {
                            tileBytes = bytes.slice(i * 16, (i+1) * 16);
                        }
                        let row = Math.floor(i / numTilesPerRow);
                        let col = i % numTilesPerRow;
                        let baseTileAddr = 4 * (((row * numTilesPerCanvasRow) * 64) + (col * 8));

                        if (col >= numTilesShownPerCol) continue;
                        if (row >= numTilesShownPerRow) continue;
                        
                        // iterate through rows in tile
                        for (let j = 0; j < 8; j++) {
                            let LY = row * 8 + j;
                            let b1, b2;

                            if (tileAttr & 0x40) {
                                b1 = tileBytes[(7-j)*2];
                                b2 = tileBytes[(7-j)*2+1];
                            } else {
                                b1 = tileBytes[j*2];
                                b2 = tileBytes[j*2+1];
                            }

                            if (tileAttr & 0x20) {
                                b1 = parseInt(Array.from(b1.toString(2).padStart(8, '0')).reverse().join(''), 2);
                                b2 = parseInt(Array.from(b2.toString(2).padStart(8, '0')).reverse().join(''), 2);
                            }

                            let baseRowAddr = baseTileAddr + 4 * (j * numTilesPerCanvasRow * 8);
                            // iterate through bits
                            for (let k = 0; k < 8; k++) {
                                let colIdx = (b2 & 1) * 2 + (b1 & 1);
                                let bitAddr = baseRowAddr + 4 * (7-k);
                                
                                if (isGBC) {
                                    let tilePalette = this.vram1[0x1800+i]&7;
                                    if (this.screenSpec.isHighColor) {
                                        colBgPalettes = highColLYtoPalsMap[LY];
                                    }
                                    let baseComps = colBgPalettes[tilePalette][colIdx];

                                    data[bitAddr] = baseComps[0];
                                    data[bitAddr+1] = baseComps[1];
                                    data[bitAddr+2] = baseComps[2];
                                } else {
                                    let baseCol = bgPalettes[colIdx];
                                    
                                    data[bitAddr] = baseCol;
                                    data[bitAddr+1] = baseCol;
                                    data[bitAddr+2] = baseCol;
                                }

                                data[bitAddr+3] = 255;
                                b1 >>= 1;
                                b2 >>= 1;
                            }
                        }
                    }
                    ctx.putImageData(myImageData, 0, 0);
                }
            }

            let app = new Vue({
                el: '#root',
                data: {
                    uint8view: null,
                    screenMap: {},
                    animateBtns: {
                        'Cyber Front': ['Cyber Front'],
                    },
                    screens: [
                        {
                            name: "DMG",
                            sources: [
                                ['rleXorCopy', 0x16, 0x4000, 0x8800],
                                ['rleXorCopy', 0x1d, 0x7880, 0x9800],
                            ],
                        },
                        {
                            name: "Media Factory (gs $02)",
                            sources: [
                                ['simpleCopy', 0x34, 0x7a21, 0x8000, 0x1c0],
                                ['simpleCopy', 0x34, 0x7be1, 0x9000, 0x1c0],
                                ['screenCopy', 0x34, 0x704a, 0x1800, 'rom', 'vram1'],
                                ['screenCopy', 0x34, 0x71b2, 0x9800],
                                ['simpleCopy', 0x35, 0x4788, 0x0000, 0x40, 'rom', 'bgPalettes'],
                            ],
                            isGBC: true,
                        },
                        {
                            name: "Media Factory sprites",
                            sources: [
                                ['simpleCopy', 0x34, 0x7a21, 0x8000, 0x1c0],
                                ['simpleCopy', 0x34, 0x7be1, 0x9000, 0x1c0],
                                ['fillScreen', 0, 0, 0],
                                ['spriteCopy', 0x30, 0x412a, 0x9800],
                                ['spriteCopy', 0x30, 0x415a, 0x9840],
                                ['simpleCopy', 0x35, 0x4788, 0x0000, 0x40, 'rom', 'bgPalettes'],
                            ],
                            isGBC: true,
                            is8000: true,
                        },
                        {
                            name: "Red Company",
                            sources: [
                                ['simpleCopy', 0x34, 0x4000, 0x9000, 0x5e0],
                                ['screenCopy', 0x34, 0x6d7a, 0x1800, 'rom', 'vram1'],
                                ['screenCopy', 0x34, 0x6ee2, 0x9800],
                                ['simpleCopy', 0x32, 0x7ff6, 0x0000, 0x08, 'rom', 'bgPalettes'],
                            ],
                            isGBC: true,
                        },
                        {
                            name: "Jupiter",
                            sources: [
                                ['rleXorCopy', 0x33, 0x7c1c, 0x8000],
                                ['screenCopy', 0x34, 0x67da, 0x1800, 'rom', 'vram1'],
                                ['screenCopy', 0x34, 0x6942, 0x9800],
                                ['simpleCopy', 0x32, 0x7f86, 0x0000, 0x40, 'rom', 'bgPalettes'],
                            ],
                            isGBC: true,
                        },
                        {
                            name: "Jupiter sprites 1",
                            sources: [
                                ['rleXorCopy', 0x33, 0x7c1c, 0x8000],
                                ['fillScreen', 0, 0, 0],
                                ['spriteCopy', 0x30, 0x4be6, 0x9800, true],
                                ['spriteCopy', 0x30, 0x4cb6, 0x9900, true],
                                ['simpleCopy', 0x32, 0x7fc6, 0x0000, 0x30, 'rom', 'bgPalettes'],
                            ],
                            isGBC: true,
                            is8000: true,
                        },
                        {
                            name: "Jupiter sprites 2",
                            sources: [
                                ['rleXorCopy', 0x33, 0x7c1c, 0x8000],
                                ['fillScreen', 0, 0, 0],
                                ['spriteCopy', 0x30, 0x4d1e, 0x9800, true],
                                ['spriteCopy', 0x30, 0x4d86, 0x9900, true],
                                ['simpleCopy', 0x32, 0x7fc6, 0x0000, 0x30, 'rom', 'bgPalettes'],
                            ],
                            isGBC: true,
                            is8000: true,
                        },
                        {
                            name: "Title Screen (gs $36)",
                            sources: [
                                ['rleXorCopy', 0x9a, 0x4ec5, 0xd000],
                                ['simpleCopy', 0x00, 0xd000, 0x8000, 0x600, 'memory', 'memory'],

                                ['rleXorCopy', 0x95, 0x4e1f, 0xd800],
                                ['simpleCopy', 0x00, 0xd600, 0x8600, 0x600, 'memory', 'memory'],

                                ['rleXorCopy', 0x9a, 0x49e0, 0xd000],
                                ['simpleCopy', 0x00, 0xdc00, 0x8c00, 0x400, 'memory', 'memory'],
                                ['simpleCopy', 0x00, 0xd000, 0x9000, 0x200, 'memory', 'memory'],
                                ['simpleCopy', 0x00, 0xd200, 0x9200, 0x600, 'memory', 'memory'],

                                ['rleXorCopy', 0xa1, 0x42ac, 0xd800],
                                ['simpleCopy', 0x00, 0xd800, 0x0000, 0x600, 'memory', 'vram1'],

                                ['rleXorCopy', 0x97, 0x78d3, 0xd000],
                                ['simpleCopy', 0x00, 0xde00, 0x0600, 0x200, 'memory', 'vram1'],
                                ['simpleCopy', 0x00, 0xd000, 0x0800, 0x400, 'memory', 'vram1'],

                                ['rleXorCopy', 0xa3, 0x5587, 0xd800],
                                ['simpleCopy', 0x00, 0xd400, 0x0c00, 0x400, 'memory', 'vram1'],
                                ['simpleCopy', 0x00, 0xd800, 0x1000, 0x200, 'memory', 'vram1'],
                                ['simpleCopy', 0x00, 0xda00, 0x1200, 0x600, 'memory', 'vram1'],
                                
                                ['screenCopy', 0x97, 0x4000, 0xd000, 'rom', 'memory', 0x14, 0x2a],
                                ['screenCopy', 0x97, 0x4348, 0xd800, 'rom', 'memory', 0x14, 0x2a],
                                ['simpleCopy', 0x00, 0xd000, 0x1800, 0x240, 'memory', 'vram1'],
                                ['simpleCopy', 0x00, 0xd240, 0x1900, 0xc0, 'memory', 'vram1'],
                                ['simpleCopy', 0x00, 0xd800, 0x9800, 0x240, 'memory', 'memory'],
                                ['simpleCopy', 0x00, 0xda40, 0x9900, 0xc0, 'memory', 'memory'],
                                ['simpleCopy', 0xa3, 0x6ecc, 0x0000, 0x40, 'rom', 'bgPalettes'],
                            ],
                            isGBC: true,
                        },
                        {
                            name: "Title screen sprites",
                            sources: [
                                ['rleXorCopy', 0x9a, 0x4ec5, 0xd000],
                                ['simpleCopy', 0x00, 0xd000, 0x8000, 0x600, 'memory', 'memory'],
                                ['rleXorCopy', 0x95, 0x4e1f, 0xd800],
                                ['simpleCopy', 0x00, 0xd600, 0x8600, 0x600, 'memory', 'memory'],
                                ['rleXorCopy', 0x9a, 0x49e0, 0xd000],
                                ['simpleCopy', 0x00, 0xdc00, 0x8c00, 0x400, 'memory', 'memory'],

                                ['rleXorCopy', 0xa1, 0x42ac, 0xd800],
                                ['simpleCopy', 0x00, 0xd800, 0x0000, 0x600, 'memory', 'vram1'],
                                ['rleXorCopy', 0x97, 0x78d3, 0xd000],
                                ['simpleCopy', 0x00, 0xde00, 0x0600, 0x200, 'memory', 'vram1'],
                                ['simpleCopy', 0x00, 0xd000, 0x0800, 0x400, 'memory', 'vram1'],
                                ['rleXorCopy', 0xa3, 0x5587, 0xd800],
                                ['simpleCopy', 0x00, 0xd400, 0x0c00, 0x400, 'memory', 'vram1'],

                                ['fillScreen', 0, 0x7f, 0],
                                ['spriteCopy', 0x0e, 0x6c84, 0x9800, true, 0x30, 0x30],
                                ['spriteCopy', 0x0e, 0x6cbc, 0x9800, true, 0x30, 0x60],
                                ['spriteCopy', 0x0e, 0x6e1c, 0x9800, true, 0x30, 0xb0],

                                ['simpleCopy', 0xa3, 0x6f0c, 0x0000, 0x40, 'rom', 'bgPalettes'],
                            ],
                            isGBC: true,
                            is8000: true,
                            rowsShown: 32,
                            canvasHeight: 32 * 8,
                        },
                        {
                            name: "Reset data (gs $12)",
                            sources: [
                                ['rleXorCopy', 0x1e, 0x4ff8, 0xd000],
                                ['simpleCopy', 0x00, 0xd000, 0x1800, 0x400, 'memory', 'vram1'],
                                ['rleXorCopy', 0x1d, 0x7a33, 0x9800],
                                ['rleXorCopy', 0x19, 0x4ccf, 0x8000],
                                ['simpleCopy', 0x1e, 0x7a4e, 0x0000, 0x40, 'rom', 'bgPalettes'],
                            ],
                            isGBC: true,
                        },
                        {
                            name: "Title menu screen opts",
                            sources: [
                                ['rleXorCopy', 0x9f, 0x4000, 0xd000],
                                ['simpleCopy', 0x00, 0xd000, 0x0000, 0x800, 'memory', 'vram1'],
                                ['spriteCopy', 0x0e, 0x4730, 0x9800, true, 0x00, 0x00],
                                ['spriteCopy', 0x0e, 0x4750, 0x9800, true, 0x00, 0x10],
                                ['spriteCopy', 0x0e, 0x4770, 0x9800, true, 0x00, 0x20],
                                ['spriteCopy', 0x0e, 0x4790, 0x9800, true, 0x00, 0x30],
                                ['spriteCopy', 0x0e, 0x47b0, 0x9800, true, 0x00, 0x40],
                                ['spriteCopy', 0x0e, 0x47d0, 0x9800, true, 0x00, 0x50],
                                ['spriteCopy', 0x0e, 0x47f0, 0x9800, true, 0x00, 0x60],
                                ['spriteCopy', 0x0e, 0x4810, 0x9800, true, 0x00, 0x70],
                                ['spriteCopy', 0x0e, 0x4830, 0x9800, true, 0x40, 0x00],
                                ['spriteCopy', 0x0e, 0x4850, 0x9800, true, 0x40, 0x10],
                                ['spriteCopy', 0x0e, 0x4870, 0x9800, true, 0x40, 0x20],
                                ['spriteCopy', 0x0e, 0x4890, 0x9800, true, 0x40, 0x30],
                                ['spriteCopy', 0x0e, 0x48b0, 0x9800, true, 0x40, 0x40],
                                ['spriteCopy', 0x0e, 0x48d0, 0x9800, true, 0x40, 0x50],
                                ['spriteCopy', 0x0e, 0x48f0, 0x9800, true, 0x40, 0x60],
                                ['spriteCopy', 0x0e, 0x4910, 0x9800, true, 0x40, 0x70],
                            ],
                            is8000: true,
                        },
                        {
                            name: "Settings (gs $17)",
                            sources: [
                                ['rleXorCopy', 0x16, 0x7701, 0xd000],
                                ['simpleCopy', 0x00, 0xd000, 0x0800, 0x600, 'memory', 'vram1'],
                                ['simpleCopy', 0x00, 0xd600, 0x0e00, 0x600, 'memory', 'vram1'],
                                ['simpleCopy', 0x00, 0xdc00, 0x1400, 0x400, 'memory', 'vram1'],

                                ['rleXorCopy', 0x1e, 0x7d0d, 0xd000],
                                ['simpleCopy', 0x00, 0xd000, 0x8000, 0x200, 'memory', 'memory'],
                                ['simpleCopy', 0x00, 0xd200, 0x8200, 0x600, 'memory', 'memory'],

                                ['rleXorCopy', 0x16, 0x5793, 0xd000],
                                ['simpleCopy', 0x00, 0xd000, 0x8800, 0x600, 'memory', 'memory'],
                                ['simpleCopy', 0x00, 0xd600, 0x8e00, 0x600, 'memory', 'memory'],
                                ['simpleCopy', 0x00, 0xdc00, 0x9400, 0x400, 'memory', 'memory'],

                                ['rleXorCopy', 0x1d, 0x678f, 0xd800],
                                ['simpleCopy', 0x00, 0xd800, 0x9800, 0x400, 'memory', 'memory'],

                                ['rleXorCopy', 0x1b, 0x7eba, 0xd800],
                                ['simpleCopy', 0x00, 0xd800, 0x1800, 0x400, 'memory', 'vram1'],
                                
                                ['simpleCopy', 0x1e, 0x677c, 0x0000, 0x40, 'rom', 'bgPalettes'],
                            ],
                            isGBC: true,
                            colsShown: 32,
                            canvasWidth: 32 * 8,
                        },
                        {
                            name: "Save screen (gs $0e)",
                            sources: [
                                ['rleXorCopy', 0x1b, 0x450c, 0xd000],
                                ['simpleCopy', 0x00, 0xd000, 0x8000, 0x800, 'memory', 'memory'],

                                ['rleXorCopy', 0x14, 0x6e31, 0xd000],
                                ['simpleCopy', 0x00, 0xd000, 0x8800, 0x1000, 'memory', 'memory'],

                                ['rleXorCopy', 0x19, 0x5fb2, 0xd000],
                                ['simpleCopy', 0x00, 0xd000, 0x0800, 0x800, 'memory', 'vram1'],

                                ['rleXorCopy', 0x1c, 0x79a7, 0xd400],
                                ['simpleCopy', 0x00, 0xd400, 0x9800, 0x400, 'memory', 'memory'],

                                ['rleXorCopy', 0x1d, 0x750b, 0xd000],
                                ['simpleCopy', 0x00, 0xd000, 0x1800, 0x400, 'memory', 'vram1'],
                                
                                ['simpleCopy', 0x1e, 0x65fc, 0x0000, 0x40, 'rom', 'bgPalettes'],
                            ],
                            isGBC: true,
                            rowsShown: 32,
                            canvasHeight: 32 * 8,
                        },
                        {
                            name: "Dorm Room (gs $45)",
                            sources: [
                                ['rleXorCopy', 0x93, 0x4930, 0xd000],
                                ['simpleCopy', 0x00, 0xd000, 0x8800, 0x1000, 'memory', 'memory'],

                                ['rleXorCopy', 0x9d, 0x4000, 0xd000],
                                ['simpleCopy', 0x00, 0xd000, 0x0000, 0x0800, 'memory', 'vram1'],

                                ['rleXorCopy', 0x92, 0x752c, 0xd000],
                                ['simpleCopy', 0x00, 0xd000, 0x0800, 0x1000, 'memory', 'vram1'],

                                ['screenCopy', 0x99, 0x72f0, 0xd800, 'rom', 'memory', 0x14, 0x20],
                                ['screenCopy', 0x99, 0x72f0+0x280, 0xdc00, 'rom', 'memory', 0x14, 0x20],
                                //['screenCopy', 0x99, 0x77f0, 0xd800, 'rom', 'memory', 0x14, 0x20],
                                //['screenCopy', 0x99, 0x77f0+0x280, 0xdc00, 'rom', 'memory', 0x14, 0x20],

                                ['simpleCopy', 0x00, 0xd800, 0x1800, 0x400, 'memory', 'vram1'],
                                ['simpleCopy', 0x00, 0xdc00, 0x9800, 0x400, 'memory', 'memory'],
                                
                                ['simpleCopy', 0xa3, 0x6d4c, 0x0000, 0x40, 'rom', 'bgPalettes'],
                                //['simpleCopy', 0xa3, 0x6dcc, 0x0000, 0x40, 'rom', 'bgPalettes'],
                            ],
                            isGBC: true,
                            rowsShown: 32,
                            canvasHeight: 32 * 8,
                        },
                        {
                            name: "Enter name (gs $16)",
                            sources: [
                                ['rleXorCopy', 0x1e, 0x4000, 0xd000],
                                ['simpleCopy', 0x00, 0xd000, 0x1800, 0x400, 'memory', 'vram1'],

                                ['rleXorCopy', 0x1c, 0x4ee1, 0xd000],
                                ['simpleCopy', 0x00, 0xd000, 0x800, 0x0800, 'memory', 'vram1'],

                                ['rleXorCopy', 0x1d, 0x567f, 0xd000],
                                ['simpleCopy', 0x00, 0xd000, 0x9800, 0x400, 'memory', 'memory'],
                                
                                ['simpleCopy', 0x1e, 0x66fc, 0x0000, 0x40, 'rom', 'bgPalettes'],
                            ],
                            isGBC: true,
                            colsShown: 21,
                            canvasWidth: 21 * 8,
                            rowsShown: 32,
                            canvasHeight: 32 * 8,
                        },
                        {
                            name: "File load display (gs $3c)",
                            sources: [
                                ['rleXorCopy', 0x91, 0x6dc4, 0x8000],
                                ['screenCopy', 0x96, 0x7c90, 0xd000, 'rom', 'memory', 0x14, 0x16],
                                ['screenCopy', 0x96, 0x7e48, 0xd400, 'rom', 'memory', 0x14, 0x16],
                                ['simpleCopy', 0x00, 0xd000, 0x1800, 0x400, 'memory', 'vram1'],
                                ['simpleCopy', 0x00, 0xd400, 0x9800, 0x400, 'memory', 'memory'],
                                ['simpleCopy', 0xa3, 0x6fcc, 0x0000, 0x40, 'rom', 'bgPalettes'],
                            ],
                            isGBC: true,
                            showTileData: true,
                        },
                    ],
                },
                methods: {
                    animate: function(btnName) {
                        for (let btn in this.animateBtns) {
                            let affected = this.animateBtns[btn];
                            if (btn === btnName) {
                                for (let i = 0; i < affected.length; i++) {
                                    let screen = this.screenMap[affected[i]];
                                    screen.screenSpec.animateIdx = screen.screenSpec.animateStartIdx;
                                    screen.canAnimate = true;
                                    screen.drawScreen();
                                }
                            } else {
                                for (let i = 0; i < affected.length; i++) {
                                    this.screenMap[affected[i]].canAnimate = false;
                                }
                            }
                        }
                    },

                    loadScenery: function() {
                        for (let i = 1; i < 197; i++) {
                            this.screens.push({
                                name: `Scenery: ${i.toString(16)}`,
                                sources: [
                                    ['sceneryCopy', 0x00, i],
                                ],
                                isGBC: true,
                                rowsShown: 10,
                                canvasHeight: 10 * 8,
                            })
                        }
                    },

                    loadPortraits: function() {
                        let portraitSrc = bankConv(0xa, 0x564c);

                        for (let i = 0; i < 18; i++) {
                            let bank = this.uint8view[portraitSrc+i*3+2];
                            let addr = this.wordIn(portraitSrc+i*3);

                            this.screens.push({
                                name: `Char ${i}`,
                                sources: [
                                    ['simpleCopy', bank, addr, 0x9000, 0x180],
                                    ['setBytes', 0, 0, 0x9800, 0, 1, 2, 3],
                                    ['setBytes', 0, 0, 0x9820, 4, 5, 6, 7],
                                    ['setBytes', 0, 0, 0x9840, 8, 9, 10, 11],
                                    ['setBytes', 0, 0, 0x9860, 12, 13, 14, 15],
                                    ['setBytes', 0, 0, 0x9880, 16, 17, 18, 19],
                                    ['setBytes', 0, 0, 0x98a0, 20, 21, 22, 23],
                                ],
                                rowsShown: 6,
                                canvasHeight: 6 * 8,
                                colsShown: 4,
                                canvasWidth: 4 * 8,
                            })
                        }
                    },

                    loadData: function() {
                        fetch('/sakuraWars1.gbc')
                            .then(response => checkStatus(response) && response.arrayBuffer())
                            .then(buffer => {
                                this.uint8view = new Uint8Array(buffer);

                                //this.loadPortraits();
                                //this.loadScenery();

                                setTimeout(this.loadScreens, 5);
                            });
                    },

                    wordIn: function(addr) {
                        return wordIn(this.uint8view, addr);
                    },

                    loadScreens: function() {
                        if (this.uint8view === null) return;

                        let newScreenMap = {};
                        for (let screenData of this.screens) {
                            let screenName = screenData.name;
                            let screen = new Screen(screenData, this.uint8view);
                            newScreenMap[screenName] = screen;
                            screen.drawScreen();
                        }
                        this.screenMap = newScreenMap;
                    },
                },
                computed: {},
            });

            app.loadData();

            function checkStatus(response) {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} - ${response.statusText}`);
                }
                return response;
            }
        </script>
    </body>
</html>